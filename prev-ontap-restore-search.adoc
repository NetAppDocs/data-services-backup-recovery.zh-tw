---
sidebar: sidebar 
permalink: prev-ontap-restore-search.html 
keywords: backing up, back up, backup, backup application data, Amazon Web services, AWS, NetApp Backup and Recovery, Oracle database, Microsoft SQL Server database, SAP HANA database 
summary: 您可以使用搜尋和復原功能從ONTAP備份檔案中還原磁碟區、資料夾或檔案。 
---
= 使用搜尋和恢復功能從ONTAP備份中恢復
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
您可以使用搜尋和復原功能從ONTAP備份檔案中還原磁碟區、資料夾或檔案。搜尋和復原功能可讓您搜尋所有備份（包括本機快照、複製磁碟區和物件儲存），而無需提供確切的系統、磁碟區或檔案名稱。

從本機快照或複製磁碟區復原通常比從物件儲存復原更快、更便宜。

還原整個磁碟區時， NetApp Backup and Recovery會使用備份資料建立一個新磁碟區。您可以還原到原始系統、同一雲端帳戶內的另一個系統或本機ONTAP系統。資料夾和檔案可以恢復到其原始位置、同一系統中的不同磁碟區、同一雲端帳戶中的另一個系統或本機系統。

復原功能取決於您的ONTAP版本：

* *資料夾：* 使用ONTAP 9.13.0 或更高版本，您可以還原包含所有檔案和子資料夾的資料夾；使用早期版本，您只能還原資料夾中的檔案。
* *歸檔儲存：*從歸檔儲存復原（ ONTAP 9.10.1 或更高版本可用）速度較慢，並且可能會產生額外費用。
* *目標群集需求：*
+
** 磁碟區恢復： ONTAP 9.10.1 或更高版本
** 檔案復原： ONTAP 9.11.1 或更高版本
** Google Archive 和StorageGRID： ONTAP 9.12.1 或更高版本
** 資料夾恢復： ONTAP 9.13.1 或更高版本




ifdef::aws[]

link:prev-reference-aws-archive-storage-tiers.html["了解有關從 AWS 檔案儲存恢復的更多信息"]。

endif::aws[]

ifdef::azure[]

link:prev-reference-azure-archive-storage-tiers.html["了解有關從 Azure 檔案儲存還原的詳細信息"]。

endif::azure[]

ifdef::gcp[]

link:prev-reference-gcp-archive-storage-tiers.html["詳細了解如何從 Google 存檔儲存中恢復"]。

endif::gcp[]

[NOTE]
====
* 如果物件儲存中的備份檔案已配置 DataLock 和勒索軟體保護，則僅當ONTAP版本為 9.13.1 或更高版本時才支援資料夾級還原。如果您使用的是早期版本的ONTAP，則可以從備份檔案還原整個卷，然後存取所需的資料夾和檔案。
* 如果物件儲存中的備份檔案駐留在檔案儲存中，則僅當ONTAP版本為 9.13.1 或更高版本時才支援資料夾層級還原。如果您使用的是早期版本的ONTAP，則可以從尚未存檔的較新備份檔案中還原資料夾，也可以從已存檔的備份中還原整個磁碟區，然後存取所需的資料夾和檔案。
* 將資料從 Azure 檔案儲存還原到StorageGRID系統時，不支援「高」還原優先權。
* 目前不支援從ONTAP S3 物件儲存中的磁碟區還原資料夾。


====
在開始之前，您應該對要還原的磁碟區或檔案的名稱或位置有所了解。



== 搜尋和恢復支援的系統和物件儲存提供者

您可以將ONTAP資料從位於二級系統（複製磁碟區）或物件儲存（備份檔案）中的備份檔案還原到下列系統。快照保存在來源系統上，並且只能還原到同一系統。

*注意：*您可以從任何類型的備份文件還原磁碟區和文件，但目前只能從物件儲存中的備份文件還原資料夾。

[cols="33,33,33"]
|===
2+| 備份檔案位置 | 目的地系統 


| *物件儲存（備份）* | *輔助系統（複製）* | ifdef::aws[] 


| 亞馬遜 S3 | AWS 本機ONTAP系統中的Cloud Volumes ONTAP | AWS 本機ONTAP系統中的Cloud Volumes ONTAP endif::aws[] ifdef::azure[] 


| Azure Blob | Azure 本地端ONTAP系統中的Cloud Volumes ONTAP | Azure 中的Cloud Volumes ONTAP本地ONTAP系統 endif::azure[] ifdef::gcp[] 


| Google 雲端儲存 | Google 本機ONTAP系統中的Cloud Volumes ONTAP | Google 本地ONTAP系統中的Cloud Volumes ONTAP endif::gcp[] 


| NetAppStorageGRID | 本機ONTAP系統Cloud Volumes ONTAP | 本地ONTAP系統 


| ONTAP S3 | 本機ONTAP系統Cloud Volumes ONTAP | 本地ONTAP系統 
|===
對於搜尋和還原，控制台代理可以安裝在以下位置：

ifdef::aws[]

* 對於 Amazon S3，控制台代理可以部署在 AWS 或您的場所


endif::aws[]

ifdef::azure[]

* 對於 Azure Blob，控制台代理程式可以部署在 Azure 中或您的本機


endif::azure[]

ifdef::gcp[]

* 對於 Google Cloud Storage，控制台代理程式必須部署在您的 Google Cloud Platform VPC 中


endif::gcp[]

* 對於StorageGRID，控制台代理必須部署在您的場所；無論是否有網路存取
* 對於ONTAP S3，控制台代理可以部署在您的場所（有或沒有網路存取）或雲端供應商環境中


請注意，「本地ONTAP系統」包括FAS、 AFF和ONTAP Select系統。



== 搜尋與恢復的先決條件

在啟用搜尋和復原功能前，請確保您的環境符合以下要求：

* 集群要求：
+
** ONTAP版本必須為 9.8 或更高版本。
** 磁碟區所在的儲存虛擬機器 (SVM) 必須具有配置的資料 LIF。
** 必須在磁碟區上啟用 NFS（支援 NFS 和 SMB/CIFS 磁碟區）。
** 必須在 SVM 上啟動 SnapDiff RPC 伺服器。當您在系統上啟用索引時，控制台會自動執行此操作。（SnapDiff 是一種能夠快速識別快照之間檔案和目錄差異的技術。）


* NetApp建議在控制台代理上掛載單獨的捲，以提高搜尋和復原的彈性。有關說明，請參閱<<mount-volume-steps,掛載磁碟區以重新索引目錄>>。




=== 舊版搜尋與復原的先決條件（使用索引目錄 v1）

以下是使用傳統索引時搜尋和復原功能的要求：

[%collapsible]
====
ifdef::aws[]

* AWS 需求：
+
** 必須將特定的 Amazon Athena、AWS Glue 和 AWS S3 權限新增至為控制台提供權限的使用者角色。link:prev-ontap-backup-onprem-aws.html["確保所有權限均已正確配置"]。
+
請注意，如果您已經使用過去設定的控制台代理程式來使用NetApp Backup and Recovery ，則現在需要將 Athena 和 Glue 權限新增至控制台使用者角色。它們是搜尋和恢復所必需的。





endif::aws[]

ifdef::azure[]

* Azure 需求：
+
** 您必須向您的訂閱註冊 Azure Synapse Analytics 資源提供者（稱為「Microsoft.Synapse」）。 https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/resource-providers-and-types#register-resource-provider["了解如何為您的訂閱註冊此資源提供程序"^] 。您必須是訂閱*擁有者*或*貢獻者*才能註冊資源提供者。
** 必須將特定的 Azure Synapse Workspace 和 Data Lake Storage 帳戶權限新增至為控制台提供權限的使用者角色。link:prev-ontap-backup-onprem-azure.html["確保所有權限均已正確配置"]。
+
請注意，如果您已經使用NetApp Backup and Recovery以及過去配置的控制台代理，則現在需要將 Azure Synapse Workspace 和 Data Lake Storage 帳戶權限新增至控制台使用者角色。它們是搜尋和恢復所必需的。

** 控制台代理必須配置為*不帶*代理伺服器才能與網際網路進行 HTTP 通訊。如果您已為控制台代理程式設定了 HTTP 代理伺服器，則無法使用搜尋和還原功能。




endif::azure[]

ifdef::gcp[]

* Google Cloud 需求：
+
** 必須將特定的 Google BigQuery 權限新增至為NetApp Console提供權限的使用者角色。link:prev-ontap-backup-onprem-gcp.html["確保所有權限均已正確配置"]。
+
如果您已經使用NetApp Backup and Recovery以及您過去設定的控制台代理，現在需要將 BigQuery 權限新增至控制台使用者角色。它們是搜尋和恢復所必需的。





endif::gcp[]

* StorageGRID和ONTAP S3 需求：
+
根據您的配置，有兩種方法可以實現“搜尋和還原”：

+
** 如果您的帳戶中沒有雲端提供者憑證，則索引目錄資訊將儲存在控制台代理程式上。
+
有關索引目錄 v2 的信息，請參閱下面有關如何啟用索引目錄的部分。

** 如果您在私人（暗）網站中使用控制台代理，則索引目錄資訊將儲存在控制台代理上（需要控制台代理版本 3.9.25 或更高版本）。
** 如果你有 https://docs.netapp.com/us-en/console-setup-admin/concept-accounts-aws.html["AWS 憑證"^]或者 https://docs.netapp.com/us-en/console-setup-admin/concept-accounts-azure.html["Azure 憑證"^]在帳戶中，索引目錄儲存在雲端提供者處，就像在雲端部署控制台代理程式一樣。  （如果您擁有這兩張憑證，則預設選擇 AWS。）
+
即使您使用的是本機控制台代理，也必須滿足控制台代理權限和雲端提供者資源的雲端提供者要求。使用此實作時，請參閱上面的 AWS 和 Azure 要求。





====


== 搜尋和恢復過程

這個過程如下：

. 在使用搜尋和還原之前，您需要在要從中還原磁碟區資料的每個來源系統上啟用「索引」。這使得索引目錄可以追蹤每個卷的備份檔案。
. 當您想要從磁碟區備份中還原磁碟區或檔案時，在「搜尋與還原」下選擇「*搜尋和還原*」。
. 透過部分或完整磁碟區名稱、部分或完整檔案名稱、備份位置、大小範圍、建立日期範圍、其他搜尋篩選器輸入磁碟區、資料夾或檔案的搜尋條件，然後選擇*搜尋*。
+
搜尋結果頁面顯示具有符合搜尋條件的文件或磁碟區的所有位置。

. 選擇要用於還原磁碟區或檔案的位置的“查看所有備份”，然後在要使用的實際備份檔案上選擇“還原”。
. 選擇您想要復原磁碟區、資料夾或檔案的位置，然後選擇*復原*。
. 磁碟區、資料夾或檔案已恢復。


image:diagram_search_restore_vol_file.png["此圖顯示了使用「搜尋和還原」執行磁碟區、資料夾或檔案還原操作的流程。"]

您只需要知道部分名稱， NetApp Backup and Recovery就會搜尋所有與您的搜尋相符的備份檔案。



== 為每個系統啟用索引目錄

在使用搜尋和還原之前，您需要在計劃還原磁碟區或檔案的每個來源系統上啟用「索引」。這使得索引目錄可以追蹤每個捲和每個備份檔案 - 使您的搜尋非常快速和有效率。

索引目錄是一個資料庫，用於儲存系統中所有磁碟區和備份檔案的元資料。搜尋和復原功能使用它來快速找到包含要復原的資料的備份檔案。

.索引目錄功能
使用索引目錄時， NetApp Backup and Recovery不會配置單獨的儲存桶。相反，對於儲存在 AWS、Azure、Google Cloud Platform、 StorageGRID或ONTAP S3 中的備份，該服務會在控制台代理或雲端提供者環境上提供空間。

索引目錄支援以下功能：

* 3分鐘內即可實現全球搜尋效率
* 最多 50 億個文件
* 每個集群最多 5000 個卷
* 每個磁碟區最多 10 萬個快照
* 基線索引的最長時間少於 7 天。實際時間將根據您的環境而有所不同。


.為系統啟用索引的步驟：
如果您的系統已啟用索引，請前往下一部分以還原您的資料。

您首先需要掛載一個單獨的磁碟區來存放目錄檔案。這樣可以防止因保存快照的檔案過大而導致資料遺失。並非每個叢集都需要這樣做；您可以從環境中的任何叢集掛載任何一個磁碟區。如果不這樣做，索引可能無法正常工作。

裝訂體積，請參考以下尺寸指南：

* 使用NetApp NFS 卷
* 建議使用磁碟吞吐量為 300 MB/s 的AFF儲存。吞吐量降低會影響搜尋和其他操作。
* 啟用NetApp快照功能，除了保護目錄備份 zip 檔案外，還可以保護目錄元資料。
* 每10億個檔案佔用50GB空間
* 目錄資料佔用 20 GB 空間，另有空間用於建立 zip 檔案和存放臨時檔案。


[[mount-volume-steps]]
.掛載磁碟區以重新索引目錄的步驟
. 將卷掛載到 `/opt/application/netapp/cbs` 輸入以下命令，其中：
+
** `volume name` 這是在叢集上用於儲存目錄檔案的磁碟區。
** `/opt/application/netapp/cbs` 這是它安裝的路徑。
+
[source, console]
----
mount <cluster IP address>:/<volume name> /opt/application/netapp/cbs
----
+
範例：

+
[source, console]
----
mount 10.192.24.17:/CATALOG_SCALE_234 /opt/application/netapp/cbs
----




.啟用索引的步驟
. 執行下列操作之一：
+
** 如果沒有系統被索引，請在「復原儀表板」的「搜尋與復原」下，選擇「啟用系統索引」。
** 如果至少有一個系統已被索引，請在「搜尋和復原」下的「復原儀表板」上選擇「索引設定」。


. 為系統選擇*啟用索引*。


.結果
在所有服務都配置完畢並且索引目錄啟動後，系統將顯示為「活動」狀態。

根據系統中捲的大小以及所有 3 個備份位置的備份檔案數量，初始索引過程可能需要長達一個小時。此後，它會每小時透明地更新，並進行增量更改以保持最新狀態。



== 使用「搜尋和還原」功能還原磁碟區、資料夾和文件

之後<<enable-the-indexed-catalog-for-each-system,為您的系統啟用索引>>，您可以使用「搜尋和還原」還原磁碟區、資料夾和檔案。這使您可以使用廣泛的過濾器從所有備份檔案中找到要還原的確切檔案或磁碟區。

.步驟
. 從控制台選單中，選擇*保護>備份和還原*。
. 選擇“*恢復*”選項卡，將顯示“恢復儀表板”。
. 從“搜尋和恢復”部分，選擇“搜尋和恢復”。
. 從“搜尋和恢復”部分，選擇“搜尋和恢復”。
. 從「搜尋和還原」頁面：
+
.. 在「搜尋欄」中，輸入完整或部分磁碟區名稱、資料夾名稱或檔案名稱。
.. 選擇資源類型：*磁碟區*、*檔案*、*資料夾*或*全部*。
.. 在「過濾依據」區域中，選擇過濾條件。例如，您可以選擇資料所在的系統和檔案類型，例如 .JPEG 檔案。或者，如果您只想在物件儲存中的可用快照或備份檔案中搜尋結果，則可以選擇備份位置類型。


. 選擇*搜尋*，搜尋結果區域將顯示所有具有與您的搜尋相符的文件、資料夾或磁碟區的資源。
. 尋找包含您要復原的資料的資源，然後選擇「檢視所有備份」以顯示包含符合磁碟區、資料夾或檔案的所有備份檔案。
. 找到您想要用於還原資料的備份檔案並選擇*復原*。
+
請注意，搜尋結果會識別包含您搜尋檔案的本機磁碟區快照和遠端複製磁碟區。您可以選擇從雲端備份檔案、快照或複製磁碟區中還原。

. 選擇要還原磁碟區、資料夾或檔案的目標位置，然後選擇*復原*。
+
** 對於卷，您可以選擇原始目標系統，也可以選擇備用系統。還原FlexGroup磁碟區時，您需要選擇多個聚合。
** 對於資料夾，您可以還原到原始位置，也可以選擇備用位置；包括系統、磁碟區和資料夾。
** 對於文件，您可以恢復到原始位置，也可以選擇備用位置；包括系統、磁碟區和資料夾。選擇原始位置時，您可以選擇覆蓋來源檔案或建立新檔案。
+
如果您選擇本機ONTAP系統，且尚未配置與物件儲存的叢集連接，系統將提示您輸入其他資訊：

+
ifdef::aws[]

+
*** 從 Amazon S3 還原時，選擇ONTAP叢集中目標磁碟區所在的 IP 空間，輸入您建立的使用者的存取金鑰和金鑰，以授予ONTAP叢集對 S3 儲存桶的存取權限，並可選擇選擇私有 VPC 端點以進行安全資料傳輸。link:prev-ontap-backup-onprem-aws.html["查看有關這些要求的詳細信息"]。






endif::aws[]

ifdef::azure[]

* 從 Azure Blob 還原時，選擇目標磁碟區所在的ONTAP叢集中的 IP 空間，並透過選擇 VNet 和子網路來選擇用於安全資料傳輸的私有端點。link:prev-ontap-backup-onprem-azure.html["查看有關這些要求的詳細信息"]。


endif::azure[]

ifdef::gcp[]

* 從 Google Cloud Storage 復原時，選擇目標磁碟區所在的ONTAP叢集中的 IP 空間，以及用於存取物件儲存的存取金鑰和金鑰。link:prev-ontap-backup-onprem-gcp.html["查看有關這些要求的詳細信息"]。


endif::gcp[]

* 從StorageGRID還原時，輸入StorageGRID伺服器的 FQDN 和ONTAP應用於與StorageGRID進行 HTTPS 通訊的端口，輸入存取物件儲存所需的存取金鑰和金鑰，以及目標磁碟區所在的ONTAP叢集中的 IP 空間。link:prev-ontap-backup-onprem-storagegrid.html["查看有關這些要求的詳細信息"]。
* 從ONTAP S3 還原時，輸入ONTAP S3 伺服器的 FQDN 和ONTAP應用於與ONTAP S3 進行 HTTPS 通訊的端口，選擇存取物件儲存所需的存取金鑰和金鑰，以及目標磁碟區所在的ONTAP叢集中的 IP 空間。link:prev-ontap-backup-onprem-ontaps3.html["查看有關這些要求的詳細信息"]。


.結果
磁碟區、資料夾或檔案已恢復，您將返回恢復儀表板，以便您可以查看恢復操作的進度。您也可以選擇「作業監控」標籤來查看恢復進度。看link:br-use-monitor-tasks.html["作業監控頁面"]。
