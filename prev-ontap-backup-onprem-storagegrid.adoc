---
sidebar: sidebar 
permalink: prev-ontap-backup-onprem-storagegrid.html 
keywords: backing up, back up, backup, backup application data, Amazon Web services, AWS, NetApp Backup and Recovery, Oracle database, Microsoft SQL Server database, SAP HANA database 
summary: 完成NetApp備份與復原中的幾個步驟，開始將磁碟區資料從本機主ONTAP系統備份到二級儲存系統以及NetApp StorageGRID系統中的物件儲存。 
---
= 使用NetApp備份和還原將本地ONTAP資料備份到StorageGRID
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
完成NetApp備份與復原中的幾個步驟，開始將磁碟區資料從本機主ONTAP系統備份到二級儲存系統以及NetApp StorageGRID系統中的物件儲存。


NOTE: 「本地ONTAP系統」包括FAS、 AFF和ONTAP Select系統。

[]
====
*注意* 若要切換至NetApp備份與復原工作負載，請參閱link:br-start-switch-ui.html["切換到不同的NetApp備份與復原工作負載"]。

====


== 識別連接方法

下圖顯示了將本機ONTAP系統備份到StorageGRID時的每個元件以及您需要在它們之間準備的連線。

或者，您可以連接到相同本機位置的輔助ONTAP系統來複製磁碟區。

image:diagram_cloud_backup_onprem_storagegrid.png["此圖顯示了NetApp Backup and Recovery 如何與來源系統上的磁碟區以及備份檔案所在的目標儲存裝置進行通訊。"]

當控制台代理程式和本機ONTAP系統安裝在沒有網際網路存取的本機位置（「暗站」）時， StorageGRID系統必須位於同一個本機資料中心。暗站配置不支援將舊備份檔案存檔到公有雲。



== 準備控制台代理

控制台代理程式是控制台功能的主要軟體。需要控制台代理程式來備份和還原您的ONTAP資料。



=== 建立或切換控制台代理

當您將資料備份到StorageGRID時，您的場所必須有控制台代理。您需要安裝新的控制台代理或確保目前選擇的控制台代理位於本機。控制台代理可以安裝在有或沒有網路存取的網站。

* https://docs.netapp.com/us-en/console-setup-admin/concept-connectors.html["了解控制台代理"^]
* https://docs.netapp.com/us-en/console-setup-admin/task-quick-start-connector-on-prem.html["在具有網際網路存取權限的 Linux 主機上安裝控制台代理"^]
* https://docs.netapp.com/us-en/console-setup-admin/task-quick-start-private-mode.html["在沒有網際網路存取的 Linux 主機上安裝控制台代理"^]
* https://docs.netapp.com/us-en/console-setup-admin/task-manage-multiple-connectors.html#switch-between-connectors["在控制台代理之間切換"^]




=== 準備控制台代理網路要求

確保安裝控制台代理程式的網路啟用以下連線：

* 透過連接埠 443 到StorageGRID網關節點的 HTTPS 連接
* 透過連接埠 443 建立到ONTAP叢集管理 LIF 的 HTTPS 連接
* 透過連接埠 443 到NetApp Backup and Recovery 的出站網路連線（當控制台代理安裝在「暗站」時不需要）




==== 私人模式（暗站）注意事項

* NetApp備份和復原功能內建於控制台代理程式中。以私人模式安裝時，您需要定期更新控制台代理軟體才能存取新功能。檢查link:whats-new.html["NetApp備份與還原新功能"]查看每個NetApp Backup and Recovery 版本中的新功能。當您想要使用新功能時，請按照以下步驟操作 https://docs.netapp.com/us-en/console-setup-admin/task-upgrade-connector.html["升級控制台代理軟體"^]。
+
NetApp Backup and Recovery 的新版本除了可以建立物件儲存備份外，還具有安排和建立 Snapshot 副本和複製卷的功能，要求您使用控制台代理的 3.9.31 或更高版本。因此建議您取得此最新版本來管理所有備份。

* 當您在 SaaS 環境中使用NetApp Backup and Recovery 時， NetApp Backup and Recovery 設定資料將會備份到雲端。當您在沒有網路存取的網站中使用NetApp Backup and Recovery 時， NetApp Backup and Recovery 設定資料將備份到儲存備份的StorageGRID桶中。




== 驗證許可證要求

在為叢集啟動NetApp Backup and Recovery 之前，您需要從NetApp購買並啟動NetApp Backup and Recovery BYOL 授權。此許可證適用於該帳戶，可跨多個系統使用。

您需要NetApp提供的序號，以便您在許可證的有效期限和容量內使用本服務。link:br-start-licensing.html["了解如何管理您的 BYOL 許可證"] 。


TIP: 將檔案備份到StorageGRID時不支援 PAYGO 授權。



== 準備ONTAP集群

您需要準備來源本機ONTAP系統以及任何輔助本機ONTAP或Cloud Volumes ONTAP系統。

準備ONTAP集群涉及以下步驟：

* 在NetApp控制台中發現您的ONTAP系統
* 驗證ONTAP系統要求
* 驗證ONTAP網路要求以將資料備份到對象存儲
* 驗證ONTAP複製卷的網路要求




=== 在NetApp控制台中發現您的ONTAP系統

您的來源本機ONTAP系統和任何輔助本機ONTAP或Cloud Volumes ONTAP系統都必須在NetApp控制台 *系統* 頁面上可用。

您需要知道叢集管理 IP 位址和管理員使用者帳戶的密碼才能新增叢集。https://docs.netapp.com/us-en/storage-management-ontap-onprem/task-discovering-ontap.html["了解如何發現集群"^] 。



=== 驗證ONTAP系統要求

確保滿足以下ONTAP要求：

* 最低版本為ONTAP 9.8；建議使用ONTAP 9.8P13 及更高版本。
* SnapMirror許可證（包含在高級捆綁包或資料保護捆綁包中）。
+
*注意：*使用NetApp備份和復原時不需要「混合雲端捆綁包」。

+
了解如何 https://docs.netapp.com/us-en/ontap/system-admin/manage-licenses-concept.html["管理您的叢集許可證"^]。

* 時間和時區設定正確。了解如何 https://docs.netapp.com/us-en/ontap/system-admin/manage-cluster-time-concept.html["配置叢集時間"^]。
* 如果要複製數據，則應在複製資料之前驗證來源系統和目標系統是否運行相容的ONTAP版本。
+
https://docs.netapp.com/us-en/ontap/data-protection/compatible-ontap-versions-snapmirror-concept.html["查看與SnapMirror關係相容的ONTAP版本"^] 。





=== 驗證ONTAP網路要求以將資料備份到對象存儲

您必須在連接到物件儲存的系統上配置以下要求。

* 當您使用扇出備份架構時，必須在主儲存系統上設定以下設定。
* 當您使用級聯備份架構時，必須在_輔助_儲存系統上設定下列設定。


需滿足以下ONTAP集群網路需求：

* ONTAP叢集透過使用者指定的連接埠從叢集間 LIF 啟動到StorageGRID網關節點的 HTTPS 連接，以執行備份和還原作業。此連接埠可在備份設定期間配置。
+
ONTAP從物件儲存讀取和寫入資料。物件儲存從不啟動，它只是響應。

* ONTAP需要從控制台代理到叢集管理 LIF 的入站連線。控制台代理必須位於您的場所。
* 每個託管要備份的磁碟區的ONTAP節點上都需要一個叢集間 LIF。  LIF 必須與ONTAP用於連接物件儲存的 _IPspace_ 相關聯。 https://docs.netapp.com/us-en/ontap/networking/standard_properties_of_ipspaces.html["了解有關 IP 空間的更多信息"^] 。
+
設定NetApp Backup and Recovery 時，系統會提示您輸入要使用的 IP 空間。您應該選擇與每個 LIF 關聯的 IP 空間。這可能是「預設」 IP 空間或您建立的自訂 IP 空間。

* 節點的群集間 LIF 能夠存取物件儲存（當控制台代理安裝在「暗」站點時不需要）。
* 已為磁碟區所在的儲存虛擬機器設定 DNS 伺服器。了解如何 https://docs.netapp.com/us-en/ontap/networking/configure_dns_services_auto.html["為 SVM 配置 DNS 服務"^]。
* 如果您使用的 IP 空間與預設 IP 空間不同，則可能需要建立靜態路由才能存取物件儲存。
* 如有必要，請更新防火牆規則，以允許NetApp備份和復原服務透過您指定的連接埠（通常為連接埠 443）從ONTAP連接到物件存儲，並透過連接埠 53（TCP/UDP）從儲存虛擬機器到 DNS 伺服器的名稱解析流量。




=== 驗證ONTAP複製卷的網路要求

如果您打算使用NetApp Backup and Recovery 在輔助ONTAP系統上建立複製卷，請確保來源系統和目標系統符合下列網路需求。



==== 本地ONTAP網路需求

* 如果叢集位於您的場所，您應該從公司網路連接到雲端提供者中的虛擬網路。這通常是 VPN 連線。
* ONTAP叢集必須滿足額外的子網路、連接埠、防火牆和叢集要求。
+
由於您可以複製到Cloud Volumes ONTAP或本機系統，因此請查看本機ONTAP系統的對等需求。 https://docs.netapp.com/us-en/ontap-sm-classic/peering/reference_prerequisites_for_cluster_peering.html["查看ONTAP文件中的叢集對等前提條件"^] 。





==== Cloud Volumes ONTAP網路需求

* 實例的安全性群組必須包含所需的入站和出站規則：具體來說，ICMP 和連接埠 11104 和 11105 的規則。這些規則包含在預先定義的安全性群組中。




== 準備StorageGRID作為備份目標

StorageGRID必須符合以下要求。查看 https://docs.netapp.com/us-en/storagegrid-117/["StorageGRID文檔"^]了解更多。

有關StorageGRID的 DataLock 和勒索軟體復原要求的詳細信息，請參閱link:prev-ontap-policy-object-options.html["備份到物件策略選項"]。

支援的StorageGRID版本:: 支援StorageGRID 10.3 及更高版本。
+
--
若要使用 DataLock 和 Ransomware Resilience 進行備份，您的StorageGRID系統必須執行 11.6.0.3 或更高版本。

要將舊備份分層到雲端檔案存儲，您的StorageGRID系統必須運行 11.3 或更高版本。此外，您的StorageGRID系統必須在控制台*系統*頁面上被發現。

對於使用者檔案存儲，需要管理節點 IP 存取。

始終需要網關 IP 存取。

--
S3 憑證:: 您必須建立 S3 租用戶帳戶來控制對StorageGRID儲存的存取。 https://docs.netapp.com/us-en/storagegrid-117/admin/creating-tenant-account.html["有關詳細信息，請參閱StorageGRID文檔"^] 。
+
--
當您設定備份到StorageGRID時，備份精靈會提示您輸入租用戶帳戶的 S3 存取金鑰和金鑰。租用戶帳戶使NetApp Backup and Recovery 能夠驗證和存取用於儲存備份的StorageGRID桶。需要金鑰，以便StorageGRID知道誰在發出請求。

這些存取金鑰必須與具有以下權限的使用者相關聯：

[source, json]
----
"s3:ListAllMyBuckets",
"s3:ListBucket",
"s3:GetObject",
"s3:PutObject",
"s3:DeleteObject",
"s3:CreateBucket"
----
--
物件版本控制:: 您無法在物件儲存桶上手動啟用StorageGRID物件版本控制。




=== 準備將較舊的備份文件存檔到公有雲存儲

將較舊的備份檔案分層到檔案儲存中可以節省資金，因為您可以使用較便宜的儲存類別來儲存您可能不需要的備份。 StorageGRID是一種內部部署（私有雲）解決方案，不提供檔案存儲，但您可以將較舊的備份檔案移至公有雲檔案儲存。以這種方式使用時，分層到雲端儲存的資料或從雲端儲存恢復的資料會在StorageGRID和雲端儲存之間傳輸 - 控制台不參與此資料傳輸。

目前支援可讓您將備份存檔至 AWS _S3 Glacier_/_S3 Glacier Deep Archive_ 或 _Azure Archive_ 儲存體。

* ONTAP要求*

* 您的叢集必須使用ONTAP 9.12.1 或更高版本。


* StorageGRID要求*

* 您的StorageGRID必須使用 11.4 或更高版本。
* 您的StorageGRID必須 https://docs.netapp.com/us-en/storage-management-storagegrid/task-discover-storagegrid.html["在控制台中發現並可用"^]。


*Amazon S3 要求*

* 您需要註冊一個 Amazon S3 帳戶，用於儲存存檔備份所在的儲存空間。
* 您可以選擇將備份分層到 AWS S3 Glacier 或 S3 Glacier Deep Archive 儲存。link:prev-reference-aws-archive-storage-tiers.html["了解有關 AWS 存檔層的更多信息"] 。
* StorageGRID應該對儲存桶具有完全控制存取權限(`s3:*`）；但是，如果這不可能，則儲存桶策略必須向StorageGRID授予以下 S3 權限：
+
** `s3:AbortMultipartUpload`
** `s3:DeleteObject`
** `s3:GetObject`
** `s3:ListBucket`
** `s3:ListBucketMultipartUploads`
** `s3:ListMultipartUploadParts`
** `s3:PutObject`
** `s3:RestoreObject`




Azure Blob 需求

* 您需要註冊 Azure 訂閱，以取得存檔備份所在的儲存空間。
* 啟動精靈可讓您使用現有的資源群組來管理將儲存備份的 Blob 容器，或者您可以建立新的資源群組。


在為叢集的備份策略定義存檔設定時，您將輸入雲端提供者憑證並選擇要使用的儲存類別。當您啟動叢集備份時， NetApp Backup and Recovery 會建立雲端儲存桶。  AWS 和 Azure 檔案儲存所需的資訊如下所示。

image:screenshot_sg_archive_to_cloud.png["將備份檔案從StorageGRID到 AWS S3 或 Azure Blob 所需資訊的螢幕截圖。"]

您選擇的歸檔策略設定將在StorageGRID中產生資訊生命週期管理 (ILM) 策略，並將這些設定新增為「規則」。

* 如果存在現有的活動 ILM 策略，則會將新規則新增至 ILM 策略以將資料移至存檔層。
* 如果存在處於「建議」狀態的現有 ILM 策略，則無法建立和啟動新的 ILM 策略。 https://docs.netapp.com/us-en/storagegrid-117/ilm/index.html["了解有關StorageGRID ILM 策略和規則的更多信息"^] 。




== 啟動ONTAP磁碟區上的備份

隨時直接從您的本機系統啟動備份。

嚮導將引導您完成以下主要步驟：

* <<選擇要備份的捲>>
* <<定義備份策略>>
* <<檢查您的選擇>>


您還可以<<顯示 API 命令>>在審查步驟中，您可以複製程式碼來自動為未來的系統啟動備份。



=== 啟動精靈

.步驟
. 使用以下方式之一存取啟動備份和復原精靈：
+
** 從控制台*系統*頁面中，選擇系統，然後選擇右側面板中備份和還原旁邊的*啟用>備份磁碟區*。
+
如果備份目標在控制台*系統*頁面上作為系統存在，則可以將ONTAP叢集拖曳到物件儲存上。

** 在備份和復原欄中選擇*卷*。從「磁碟區」標籤中，選擇「操作 (...)」選項，然後為單一磁碟區（尚未啟用複製或備份到物件儲存）選擇「啟動備份」。


+
精靈的介紹頁面顯示保護選項，包括本機快照、複製和備份。如果您在此步驟中選擇了第二個選項，則會出現「定義備份策略」頁面，其中選擇一個磁碟區。

. 繼續以下選項：
+
** 如果您已經有控制台代理，那麼一切就緒了。只需選擇*下一步*。
** 如果您還沒有控制台代理，則會出現「新增控制台代理」選項。請參閱<<準備控制台代理>> 。






=== 選擇要備份的捲

選擇您想要保護的磁碟區。受保護的磁碟區是具有以下一項或多項的磁碟區：快照策略、複製策略、備份到物件策略。

您可以選擇保護FlexVol或FlexGroup磁碟區；但是，在啟動系統備份時不能選擇這些磁碟區的混合。了解如何link:prev-ontap-backup-manage.html["啟動系統中附加磁碟區的備份"]（FlexVol或FlexGroup）在為初始磁碟區配置備份後。

[NOTE]
====
* 您一次只能在單一FlexGroup磁碟區上啟動備份。
* 您選擇的捲必須具有相同的SnapLock設定。所有磁碟區都必須啟用SnapLock Enterprise或停用SnapLock 。


====
.步驟
如果您選擇的磁碟區已經套用了快照或複製策略，那麼您稍後選擇的策略將覆寫這些現有策略。

. 在「選擇卷」頁面中，選擇要保護的一個或多個磁碟區。
+
** 或者，過濾行以僅顯示具有特定卷類型、樣式等的捲，以便更輕鬆地進行選擇。
** 選擇第一個磁碟區後，您可以選擇所有FlexVol磁碟區（FlexGroup磁碟區一次只能選擇一個）。若要備份所有現有的FlexVol卷，請先選取一個卷，然後選取標題行中的框。
** 若要備份單一卷，請選取每個卷對應的複選框。


. 選擇“下一步”。




=== 定義備份策略

定義備份策略涉及設定以下選項：

* 您是否需要一個或所有備份選項：本機快照、複製和備份到物件存儲
* 架構
* 本機快照策略
* 複製目標和策略
+

NOTE: 如果您選擇的磁碟區具有與您在此步驟中選擇的策略不同的快照和複製策略，則現有策略將被覆寫。

* 備份到物件儲存資訊（提供者、加密、網路、備份策略和匯出選項）。


.步驟
. 在「定義備份策略」頁面中，選擇以下一項或全部。預設情況下，所有三個都被選中：
+
** *本機快照*：如果您正在執行複製或備份到物件存儲，則必須建立本機快照。
** *複製*：在另一個ONTAP儲存系統上建立複製磁碟區。
** *備份*：將磁碟區備份到物件儲存。


. *架構*：如果您同時選擇了複製和備份，請選擇下列資訊流之一：
+
** *級聯*：資訊從主存儲流向輔助存儲，然後從輔助存儲流向物件存儲。
** *扇出*：資訊從主存儲流向輔助存儲，再從主存儲流向物件存儲。
+
有關這些架構的詳細信息，請參閱link:prev-ontap-protect-journey.html["規劃您的保育之旅"]。



. *本機快照*：選擇現有的快照原則或建立新的快照策略。
+

TIP: 若要建立自訂策略，請參閱link:br-use-policies-create.html["創建策略"]。

+
若要建立策略，請選擇「建立新策略」並執行下列操作：

+
** 輸入策略的名稱。
** 選擇最多五個時間表，通常頻率不同。
** 選擇“*創建*”。


. *複製*：設定以下選項：
+
** *複製目標*：選擇目標系統和 SVM。或者，選擇將新增至複製磁碟區名稱的目標聚合或聚合以及前綴或後綴。
** *複製策略*：選擇現有的複製策略或建立一個。
+

TIP: 若要建立自訂策略，請參閱link:br-use-policies-create.html["創建策略"]。

+
若要建立策略，請選擇「建立新策略」並執行下列操作：

+
*** 輸入策略的名稱。
*** 選擇最多五個時間表，通常頻率不同。
*** 選擇“*創建*”。




. *備份到物件*：如果您選擇了*備份*，請設定以下選項：
+
** *提供者*：選擇* StorageGRID*。
** *提供者設定*：輸入提供者網關節點 FQDN 詳細資料、連接埠、存取金鑰和金鑰。
+
存取密鑰和密鑰適用於您建立的 IAM 用戶，用於授予ONTAP叢集對儲存桶的存取權限。

** *網路*：選擇要備份的磁碟區所在的ONTAP叢集中的 IP 空間。此 IP 空間的群集間 LIF 必須具有出站網際網路存取權限（當控制台代理安裝在「暗站」時不需要）。
+

TIP: 選擇正確的 IP 空間可確保NetApp Backup and Recovery 可以建立從ONTAP到StorageGRID物件儲存的連線。

** *備份策略*：選擇現有的備份到物件儲存策略或建立一個。
+

TIP: 若要建立自訂策略，請參閱link:br-use-policies-create.html["創建策略"]。

+
若要建立策略，請選擇「建立新策略」並執行下列操作：

+
*** 輸入策略的名稱。
*** 選擇最多五個時間表，通常頻率不同。
*** 對於備份到物件策略，設定 DataLock 和 Ransomware Resilience 設定。有關 DataLock 和勒索軟體恢復的詳細信息，請參閱link:prev-ontap-policy-object-options.html["備份到對象策略設置"]。
+
如果您的叢集使用的是ONTAP 9.11.1 或更高版本，您可以選擇透過設定「DataLock」和「Ransomware Resilience」來保護您的備份免遭刪除和勒索軟體攻擊。  _DataLock_ 保護您的備份檔案不被修改或刪除，而 _Ransomware Resilience_ 會掃描您的備份檔案以查找備份檔案中勒索軟體攻擊的證據。

*** 選擇“*創建*”。




+
如果您的叢集使用的是ONTAP 9.12.1 或更高版本，而您的StorageGRID系統使用的是 11.4 或更高版本，您可以選擇在一定天數後將舊備份分層到公有雲存檔層。目前支援 AWS S3 Glacier/S3 Glacier Deep Archive 或 Azure Archive 儲存層。<<準備將較舊的備份文件存檔到公有雲存儲,了解如何配置您的系統以實現此功能>> 。

+
** *分層備份到公有雲*：選擇您想要分層備份的雲端提供者並輸入提供者詳細資料。
+
選擇或建立一個新的StorageGRID叢集。有關建立StorageGRID叢集以便控制台可以發現它的詳細信息，請參閱 https://docs.netapp.com/us-en/storagegrid-117/["StorageGRID文檔"^]。

** *將現有的 Snapshot 副本匯出到物件儲存作為備份副本*：如果此系統中有任何磁碟區的本機快照副本與您剛剛為此系統選擇的備份計畫標籤（例如，每日、每週等）相匹配，則會顯示此附加提示。選取此方塊可將所有歷史快照複製到物件儲存作為備份文件，以確保對您的磁碟區進行最全面的保護。


. 選擇“下一步”。




=== 檢查您的選擇

這是審查您的選擇並在必要時進行調整的機會。

.步驟
. 在「審核」頁面中，審核您的選擇。
. （可選）選取核取方塊*自動將快照原則標籤與複製和備份策略標籤同步*。這將建立具有與複製和備份策略中的標籤相符的標籤的快照。
. 選擇*啟動備份*。


.結果
NetApp Backup and Recovery 開始對您的磁碟區進行初始備份。複製捲和備份檔案的基線傳輸包括來源資料的完整副本。後續傳輸包含 Snapshot 副本中包含的主儲存資料的差異副本。

在目標叢集中建立一個複製卷，該卷將與主儲存卷同步。

在您輸入的 S3 存取金鑰和金鑰指示的服務帳戶中建立一個 S3 儲存桶，並將備份檔案儲存在那裡。

顯示磁碟區備份儀表板，以便您可以監控備份的狀態。

您也可以使用link:br-use-monitor-tasks.html["作業監控頁面"^]。



=== 顯示 API 命令

您可能想要顯示並選擇性地複製啟動備份和還原精靈中使用的 API 命令。您可能希望這樣做以便在未來的系統中自動啟動備份。

.步驟
. 從啟動備份和復原精靈中，選擇*查看 API 請求*。
. 若要將指令複製到剪貼簿，請選擇*複製*圖示。

